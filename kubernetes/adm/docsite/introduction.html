<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.19: https://docutils.sourceforge.io/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Introduction &mdash; Ansible collections  documentation</title>
      <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/antsibull-minimal.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/ansible.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script src="../../../_static/sphinx_highlight.js"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="next" title="Requirements" href="requirments.html" />
    <link rel="prev" title="Kubernetes.Adm" href="../index.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../../index.html" class="icon icon-home"> Ansible collections
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="../../index.html">Collections in the Kubernetes Namespace</a><ul class="current">
<li class="toctree-l2 current"><a class="reference internal" href="../index.html">Kubernetes.Adm</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="../index.html#description">Description</a></li>
<li class="toctree-l3 current"><a class="reference internal" href="../index.html#general">General</a><ul class="current">
<li class="toctree-l4 current"><a class="current reference internal" href="#">Introduction</a></li>
<li class="toctree-l4"><a class="reference internal" href="requirments.html">Requirements</a></li>
<li class="toctree-l4"><a class="reference internal" href="collection_usage.html">Using The Collection</a></li>
<li class="toctree-l4"><a class="reference internal" href="example.html">Full Example with Vagrant</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../index.html#plugin-index">Plugin Index</a></li>
<li class="toctree-l3"><a class="reference internal" href="../index.html#role-index">Role Index</a></li>
</ul>
</li>
</ul>
</li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">Ansible collections</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../../index.html">Collections in the Kubernetes Namespace</a> &raquo;</li>
          <li><a href="../index.html">Kubernetes.Adm</a> &raquo;</li>
      <li>Introduction</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="introduction">
<span id="ansible-collections-kubernetes-adm-docsite-introduction"></span><h1>Introduction<a class="headerlink" href="#introduction" title="Permalink to this heading"></a></h1>
<p>This collection helps you deploy <code class="docutils literal notranslate"><span class="pre">kubeadm</span></code> based Kubernetes clusters. It’s a wrapper around <code class="docutils literal notranslate"><span class="pre">kubeadm</span></code>.</p>
<p>The collection has roles that correspond to <code class="docutils literal notranslate"><span class="pre">kubeadm</span></code> commands.
For example the <code class="docutils literal notranslate"><span class="pre">init</span></code> role corresponds to the <code class="docutils literal notranslate"><span class="pre">kubeadm</span> <span class="pre">init</span></code> command.</p>
<p>The collection uses the CRI-O container runtime(CR). Support for other CRs is not planned.</p>
<p>The collection is designed and tested for RHEL(&gt;= 8) based distributions. Support for other distributions is not planned.</p>
<p>Providing extension points to support different CRs or distributions is a goal.
The collection uses <em>tasks_file</em> variable for this purpose. The following should demonstrate.
In the <code class="docutils literal notranslate"><span class="pre">prepare</span></code> role there is the variable <code class="docutils literal notranslate"><span class="pre">cri_tasks:</span> <span class="pre">_crio.yml</span></code>. The <code class="docutils literal notranslate"><span class="pre">_crio.yml</span></code> file is a <em>tasks</em> file which
installs CRI-O. To plug in an alternative CR, set the value of <code class="docutils literal notranslate"><span class="pre">cri_tasks</span></code> to your <em>own</em> tasks file that installs your favorite CR.</p>
<section id="kubeadm">
<h2>Kubeadm<a class="headerlink" href="#kubeadm" title="Permalink to this heading"></a></h2>
<p>The collection is <em>just</em> a wrapper around <code class="docutils literal notranslate"><span class="pre">kubeadm</span></code>. It’s not an abstraction on top of it. Therefore, it’s
necessary to understand <code class="docutils literal notranslate"><span class="pre">kubeadm</span></code> to be able to use the collection.</p>
</section>
<section id="roles">
<h2>Roles<a class="headerlink" href="#roles" title="Permalink to this heading"></a></h2>
<p>The collection includes the following roles:</p>
<ul class="simple">
<li><p>common: Contains common parameters for the cluster.</p></li>
<li><p>prepare: Prepare the node for Kubernetes installation.</p></li>
<li><p>init: Initializes a new cluster using <code class="docutils literal notranslate"><span class="pre">kubeadm</span> <span class="pre">init</span></code></p></li>
<li><p>pre_join: Generate a bootstrap token and uploads the encrypted certificates.</p></li>
<li><p>join: Join a new node to an existing cluster.</p></li>
<li><p>upgrade: Upgrade Kubernetes control plane and workers.</p></li>
<li><p>keepalived: Setup a HA floating IP using <code class="docutils literal notranslate"><span class="pre">keepalived</span></code>.</p></li>
<li><p>api_server_lb: Setup a load balancer for the API server using HAProxy and keepalived for HA cluster.</p></li>
<li><p>download: Download arbitrary files, mostly for installing CLIs from Github releases.</p></li>
</ul>
</section>
<section id="bootstrapping-a-cluster">
<h2>Bootstrapping a Cluster<a class="headerlink" href="#bootstrapping-a-cluster" title="Permalink to this heading"></a></h2>
<p>To create a cluster using <code class="docutils literal notranslate"><span class="pre">kubeadm</span></code> you run the following commands:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">kubeadm</span> <span class="pre">init</span></code>: On the first control plane node.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">kubeadm</span> <span class="pre">join</span> <span class="pre">--control-plane</span></code>: On the reset of the control plane nodes.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">kubeadm</span> <span class="pre">join</span></code>: On the reset of the worker nodes.</p></li>
</ul>
<p>For the collection, in addition to the <code class="docutils literal notranslate"><span class="pre">init</span></code> and <code class="docutils literal notranslate"><span class="pre">join</span></code> roles, you will need the <code class="docutils literal notranslate"><span class="pre">prepare</span></code> and <code class="docutils literal notranslate"><span class="pre">pre_join</span></code> roles:</p>
<div class="highlight-yaml+jinja notranslate"><div class="highlight"><pre><span></span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Prepare nodes for Kubernetes</span><span class="w"></span>
<span class="w">  </span><span class="nt">hosts</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;</span><span class="cp">{{</span> <span class="nv">cluster_hostgroup</span> <span class="cp">}}</span><span class="s">&quot;</span><span class="w"></span>
<span class="w">  </span><span class="nt">any_errors_fatal</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span><span class="w"></span>
<span class="w">  </span><span class="nt">roles</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="w"> </span><span class="nv">kubernetes.adm.prepare</span><span class="w"> </span><span class="p p-Indicator">]</span><span class="w"></span>


<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Setup Load balancer for Kubernetes API server</span><span class="w"></span>
<span class="w">  </span><span class="nt">hosts</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;</span><span class="cp">{{</span> <span class="nv">control_plane_hostgroup</span> <span class="cp">}}</span><span class="s">&quot;</span><span class="w"></span>
<span class="w">  </span><span class="nt">any_errors_fatal</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span><span class="w"></span>
<span class="w">  </span><span class="nt">roles</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">kubernetes.adm.api_server_lb</span><span class="p p-Indicator">]</span><span class="w"></span>

<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Init first control plane node</span><span class="w"></span>
<span class="w">  </span><span class="nt">hosts</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;</span><span class="cp">{{</span> <span class="nv">init_node_hostgroup</span> <span class="cp">}}</span><span class="s">&quot;</span><span class="w"></span>
<span class="w">  </span><span class="nt">any_errors_fatal</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span><span class="w"></span>
<span class="w">  </span><span class="nt">roles</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">kubernetes.adm.init</span><span class="p p-Indicator">]</span><span class="w"></span>


<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">hosts</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;</span><span class="cp">{{</span> <span class="nv">init_node_hostgroup</span> <span class="cp">}}</span><span class="s">&quot;</span><span class="w"></span>
<span class="w">  </span><span class="nt">any_errors_fatal</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span><span class="w"></span>
<span class="w">  </span><span class="nt">roles</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">kubernetes.adm.pre_join</span><span class="p p-Indicator">]</span><span class="w"></span>


<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Join the rest of the control plane nodes</span><span class="w"></span>
<span class="w">  </span><span class="nt">hosts</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;</span><span class="cp">{{</span> <span class="nv">control_plane_hostgroup</span> <span class="cp">}}</span><span class="s">,!</span><span class="cp">{{</span> <span class="nv">init_node_hostgroup</span> <span class="cp">}}</span><span class="s">&quot;</span><span class="w"></span>
<span class="w">  </span><span class="nt">any_errors_fatal</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span><span class="w"></span>
<span class="w">  </span><span class="nt">serial</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1</span><span class="w"></span>
<span class="w">  </span><span class="nt">roles</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">kubernetes.adm.join</span><span class="p p-Indicator">]</span><span class="w"></span>


<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Join worker nodes</span><span class="w"></span>
<span class="w">  </span><span class="nt">hosts</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;</span><span class="cp">{{</span> <span class="nv">workers_hostgroup</span> <span class="cp">}}</span><span class="s">&quot;</span><span class="w"></span>
<span class="w">  </span><span class="nt">roles</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">kubernetes.adm.join</span><span class="p p-Indicator">]</span><span class="w"></span>
<span class="w">  </span><span class="nt">strategy</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">free</span><span class="w"></span>
</pre></div>
</div>
<p>Playbook explanation:</p>
<ul class="simple">
<li><p>Run the prepare role on all nodes. Stop on any failure.</p></li>
<li><p>Run the api_server_lb role on the control plane nodes to setup a highly available load balancer. Stop on any failure.</p></li>
<li><p>Run the init role on the first control plane node. Stop on any failure.</p></li>
<li><p>Run the pre_join role to set the required facts to join new nodes later. Stop on any failure.</p></li>
<li><p>Run the join role on the reset of the control plane nodes. One by one. Stop on any failure.</p></li>
<li><p>Run the join role on the worker nodes.</p></li>
</ul>
</section>
<section id="cluster-upgrade">
<h2>Cluster Upgrade<a class="headerlink" href="#cluster-upgrade" title="Permalink to this heading"></a></h2>
<p>As mentioned before, the collection as a wrapper around kubeadm. We don’t attempt to hide kubeadm and its interface.
So, before upgrading the cluster, follow the kubeadm documentation.
Follow any guidelines and recommendations that are necessary.
Perform any required manual migration for any configuration or resource configs.</p>
<p>The kubeadm upgrade process is the following:</p>
<ul class="simple">
<li><p>Upgrade the first(any one will work)  control plane node.</p></li>
<li><p>Upgrade the reset of the control plane nodes</p></li>
<li><p>Upgrade the kubelet on the control plane nodes.</p></li>
<li><p>Upgrade the worker nodes and then their kubelets.</p></li>
</ul>
<p>The following playbook demonstrates:</p>
<div class="highlight-yaml+jinja notranslate"><div class="highlight"><pre><span></span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">hosts</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;</span><span class="cp">{{</span> <span class="nv">init_node_hostgroup</span> <span class="cp">}}</span><span class="s">&quot;</span><span class="w"></span>
<span class="w">  </span><span class="nt">any_errors_fatal</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span><span class="w"></span>
<span class="w">  </span><span class="nt">roles</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[{</span><span class="nt"> role</span><span class="p">:</span><span class="w"> </span><span class="nv">kubernetes.adm.upgrade</span><span class="p p-Indicator">,</span><span class="nt"> phase</span><span class="p">:</span><span class="w"> </span><span class="nv">facts</span><span class="w"> </span><span class="p p-Indicator">}]</span><span class="w"></span>

<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">hosts</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;</span><span class="cp">{{</span> <span class="nv">init_node_hostgroup</span> <span class="cp">}}</span><span class="s">&quot;</span><span class="w"></span>
<span class="w">  </span><span class="nt">any_errors_fatal</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span><span class="w"></span>
<span class="w">  </span><span class="nt">roles</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[{</span><span class="nt"> role</span><span class="p">:</span><span class="w"> </span><span class="nv">kubernetes.adm.upgrade</span><span class="p p-Indicator">,</span><span class="nt"> phase</span><span class="p">:</span><span class="w"> </span><span class="nv">apply</span><span class="w"> </span><span class="p p-Indicator">}]</span><span class="w"></span>

<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">hosts</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;</span><span class="cp">{{</span> <span class="nv">control_plane_hostgroup</span> <span class="cp">}}</span><span class="s">,!</span><span class="cp">{{</span> <span class="nv">init_node_hostgroup</span> <span class="cp">}}</span><span class="s">&quot;</span><span class="w"></span>
<span class="w">  </span><span class="nt">serial</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1</span><span class="w"></span>
<span class="w">  </span><span class="nt">any_errors_fatal</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span><span class="w"></span>
<span class="w">  </span><span class="nt">roles</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[{</span><span class="nt"> role</span><span class="p">:</span><span class="w"> </span><span class="nv">kubernetes.adm.upgrade</span><span class="p p-Indicator">,</span><span class="nt"> phase</span><span class="p">:</span><span class="w"> </span><span class="nv">node</span><span class="w"> </span><span class="p p-Indicator">}]</span><span class="w"></span>

<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">hosts</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;</span><span class="cp">{{</span> <span class="nv">control_plane_hostgroup</span> <span class="cp">}}</span><span class="s">&quot;</span><span class="w"></span>
<span class="w">  </span><span class="nt">serial</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1</span><span class="w"></span>
<span class="w">  </span><span class="nt">any_errors_fatal</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span><span class="w"></span>
<span class="w">  </span><span class="nt">roles</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[{</span><span class="nt"> role</span><span class="p">:</span><span class="w"> </span><span class="nv">kubernetes.adm.upgrade</span><span class="p p-Indicator">,</span><span class="nt"> phase</span><span class="p">:</span><span class="w"> </span><span class="nv">kubelet</span><span class="w"> </span><span class="p p-Indicator">}]</span><span class="w"></span>

<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">hosts</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;</span><span class="cp">{{</span> <span class="nv">workers_hostgroup</span> <span class="cp">}}</span><span class="s">&quot;</span><span class="w"></span>
<span class="w">  </span><span class="nt">serial</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10%</span><span class="w"></span>
<span class="w">  </span><span class="nt">max_fail_percentage</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">20</span><span class="w"></span>
<span class="w">  </span><span class="nt">roles</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="p p-Indicator">{</span><span class="nt"> role</span><span class="p">:</span><span class="w"> </span><span class="nv">kubernetes.adm.upgrade</span><span class="p p-Indicator">,</span><span class="nt"> phase</span><span class="p">:</span><span class="w"> </span><span class="nv">node</span><span class="w"> </span><span class="p p-Indicator">}</span><span class="w"></span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="p p-Indicator">{</span><span class="nt"> role</span><span class="p">:</span><span class="w"> </span><span class="nv">kubernetes.adm.upgrade</span><span class="p p-Indicator">,</span><span class="nt"> phase</span><span class="p">:</span><span class="w"> </span><span class="nv">kubelet</span><span class="w"> </span><span class="p p-Indicator">}</span><span class="w"></span>
</pre></div>
</div>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="../index.html" class="btn btn-neutral float-left" title="Kubernetes.Adm" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="requirments.html" class="btn btn-neutral float-right" title="Requirements" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright Ansible contributors.</p>
  </div>

   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>